import React, { useState, useEffect, useRef } from 'react';
import { Camera, Upload, Zap, Lightbulb, Heart, Soup, Palette, Shirt, Sun, Moon, ArrowLeft, Loader2, CheckCircle } from 'lucide-react';

// --- Static Data for Recommendations ---
const recommendationsData = {
  warm: {
    undertone: "Warm (Golden/Peach)",
    description: "Your skin has golden, peach, or yellow undertones, giving you a sun-kissed appearance even without a tan. Your veins often appear greenish, and you look best in gold jewelry. This tone tends to tan easily and rarely burns.",
    colorPalette: [
      { name: "Coral", hex: "#FF7F50" },
      { name: "Olive Green", hex: "#6B8E23" },
      { name: "Cream", hex: "#FFFDD0" },
      { name: "Warm Red", hex: "#B22222" },
    ],
    fashion: {
      title: "Golden Hour Glow",
      styles: "Earthy tones, jewel tones (sapphire, ruby), creams, and deep greens.",
      outfit: "A flowing terracotta midi-dress paired with gold hoop earrings and a creamy white linen blazer.",
      productCard: [
        { name: "Terracotta Linen Dress", price: "IDR 399K", link: "#", marketplace: "Shopee" },
        { name: "Olive Green Slacks", price: "IDR 240K", link: "#", marketplace: "Zalora" },
        { name: "Chunky Gold Hoops", price: "IDR 150K", link: "#", marketplace: "Shopee" },
      ]
    },
    skincare: {
      dailyTips: "Focus on even-toning and preventing hyperpigmentation. Use Vitamin C serums in the morning to enhance your natural glow.",
      brightening: "Ingredients like Turmeric and Papaya extracts can help maintain brightness. Always use SPF to protect against sun-induced darkening.",
      routine: {
        morning: "Gentle cleanser, Vitamin C serum, Lightweight SPF 30+.",
        afternoon: "Hydrating mist (optional).",
        night: "Oil cleanser, Hydrating toner, Retinol or Niacinamide serum, Moisturizer."
      }
    },
    diet: {
      avoid: ["Excessive dairy (can cause dullness/breakouts)", "Spicy foods (can increase redness on warm skin)"],
      beneficial: ["Carrots and Sweet Potatoes (Beta-Carotene for healthy glow)", "Avocado (healthy fats for barrier repair)"],
      hydrationSleep: "Drink warm herbal teas like ginger or turmeric. Aim for 7-8 hours of sleep; use a silk pillowcase to prevent friction."
    }
  },
  cool: {
    undertone: "Cool (Pink/Blue)",
    description: "Your skin has blue, pink, or reddish undertones. Your veins often look blue or purple, and you typically look better in silver jewelry. Your skin may burn easily and tan minimally. You often have a rosy complexion.",
    colorPalette: [
      { name: "Navy Blue", hex: "#000080" },
      { name: "Emerald Green", hex: "#50C878" },
      { name: "True White", hex: "#FFFFFF" },
      { name: "Fuschia Pink", hex: "#FF00FF" },
    ],
    fashion: {
      title: "Icy Elegance",
      styles: "Deep cool colors, icy pastels, bright blues, purples, and true black/white.",
      outfit: "A crisp white blouse paired with high-waisted navy trousers and silver statement jewelry. A touch of fuschia lipstick to complement the complexion.",
      productCard: [
        { name: "True White Poplin Blouse", price: "IDR 350K", link: "#", marketplace: "Zalora" },
        { name: "Navy Blue Wide-Leg Pants", price: "IDR 420K", link: "#", marketplace: "Shopee" },
        { name: "Silver Dainty Necklace", price: "IDR 180K", link: "#", marketplace: "Zalora" },
      ]
    },
    skincare: {
      dailyTips: "Cool tones can be prone to redness and sensitivity. Use gentle, calming ingredients.",
      brightening: "Look for ingredients like Licorice Root and Chamomile to calm redness and achieve an even, porcelain finish.",
      routine: {
        morning: "Non-foaming cream cleanser, Hydrating B5 serum, Mineral-based SPF 50.",
        afternoon: "Aloe vera gel for cooling if exposed to sun.",
        night: "Micellar water pre-cleanse, Calming toner, Peptide serum, Barrier repair moisturizer."
      }
    },
    diet: {
      avoid: ["High-sodium foods (can increase puffiness and inflammation)", "Alcohol (may exacerbate redness)"],
      beneficial: ["Cucumber and Watermelon (high water content for hydration)", "Blueberries and Pomegranates (antioxidants to combat sensitivity)"],
      hydrationSleep: "Focus on cold water and green tea. Ensure a cool, dark room for sleep to minimize facial flushing."
    }
  },
  neutral: {
    undertone: "Neutral (Balanced)",
    description: "Your skin has a mix of both pink/blue and golden/yellow undertones, or your undertone perfectly matches your surface color. Your veins may appear neither distinctly blue nor green, and you look good in both gold and silver jewelry. You have the most versatility in colors.",
    colorPalette: [
      { name: "Taupe", hex: "#483C32" },
      { name: "Soft Rose", hex: "#F3D8D8" },
      { name: "Jade Green", hex: "#00A36C" },
      { name: "Plum Purple", hex: "#8E4585" },
    ],
    fashion: {
      title: "Harmonious Versatility",
      styles: "You can wear almost any color! Soft muted tones and vibrant hues both work. Avoid colors that are too fluorescent.",
      outfit: "A relaxed jade green jumpsuit accessorized with a mix of gold and silver layered necklaces. A soft rose colored lip.",
      productCard: [
        { name: "Jade Green Utility Jumpsuit", price: "IDR 580K", link: "#", marketplace: "Zalora" },
        { name: "Soft Rose Knit Sweater", price: "IDR 310K", link: "#", marketplace: "Shopee" },
        { name: "Mixed Metal Layered Chain", price: "IDR 210K", link: "#", marketplace: "Zalora" },
      ]
    },
    skincare: {
      dailyTips: "Your balance is your strength. Focus on maintenance and seasonal adjustments.",
      brightening: "Exfoliation is keyâ€”use gentle AHAs (like Lactic Acid) 2-3 times a week to reveal fresh skin and keep your tone even.",
      routine: {
        morning: "Mild foaming cleanser, Niacinamide serum, Broad-spectrum SPF 30.",
        afternoon: "Blotting paper if T-zone gets oily.",
        night: "Double cleanse with balm, Exfoliating toner (2x/wk), Hyaluronic Acid serum, Light night cream."
      }
    },
    diet: {
      avoid: ["Excessive sugar (can accelerate dullness and aging)", "Highly processed foods (impede nutrient absorption)"],
      beneficial: ["Colorful bell peppers (Vitamin A & C for collagen)", "Oily fish/Flaxseed (Omega-3s for anti-inflammation)"],
      hydrationSleep: "Vary your intake: water, coconut water, and herbal teas. Establish a strict, consistent sleep schedule to maximize cellular repair."
    }
  }
};

const ColorSwatch = ({ name, hex }) => (
  <div className="flex flex-col items-center">
    <div
      className="w-16 h-16 sm:w-20 sm:h-20 rounded-full border-4 border-gray-100 shadow-md transition-transform duration-300 hover:scale-105"
      style={{ backgroundColor: hex }}
      title={name}
    ></div>
    <p className="mt-2 text-xs font-medium text-gray-700">{name}</p>
  </div>
);

const SectionTitle = ({ icon: Icon, title, color }) => (
  <h2 className={`text-2xl sm:text-3xl font-extrabold flex items-center mb-6 pt-4 border-t-2 border-${color}-300/50`}>
    <Icon className={`w-6 h-6 mr-3 text-${color}-600`} />
    {title}
  </h2>
);

// --- Main App Component ---
const App = () => {
  const [analysisResult, setAnalysisResult] = useState(null); // 'warm', 'cool', 'neutral', or null
  const [isLoading, setIsLoading] = useState(false);
  const [photoUrl, setPhotoUrl] = useState(null);
  const [isAnalyzing, setIsAnalyzing] = useState(false); // To toggle between Hero/Results views
  const [isTryOnActive, setIsTryOnActive] = useState(false); // For try-on state
  const fileInputRef = useRef(null);
  const webcamRef = useRef(null);

  const themeColors = {
    primary: 'pink-300',
    secondary: 'violet-300',
    accent: 'gray-900',
  };

  const currentData = analysisResult ? recommendationsData[analysisResult] : null;

  // --- Utility Functions ---

  const handleFileChange = (event) => {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        setPhotoUrl(reader.result);
        mockAnalyze(reader.result);
      };
      reader.readAsDataURL(file);
    }
  };

  // Mock AI Analysis Simulation
  const mockAnalyze = () => {
    setIsLoading(true);
    // Simulate API call latency (3 seconds)
    setTimeout(() => {
      // Mock result selection (random for demonstration)
      const tones = ['warm', 'cool', 'neutral'];
      const result = tones[Math.floor(Math.random() * tones.length)];

      setAnalysisResult(result);
      setIsLoading(false);
      setIsAnalyzing(true);
    }, 3000);
  };

  const handleReset = () => {
    setAnalysisResult(null);
    setIsAnalyzing(false);
    setPhotoUrl(null);
    setIsTryOnActive(false);
    // Note: If using webcam, you'd stop the stream here.
  };

  // --- Sub-Components ---

  const ResultsDashboard = () => (
    <div className="container mx-auto p-4 sm:p-8 pt-10 text-gray-800">
      <div className="flex justify-between items-center mb-10">
        <h1 className="text-3xl sm:text-5xl font-extrabold text-gray-900 flex items-center">
          <CheckCircle className="w-8 h-8 mr-3 text-pink-500" />
          Your Luminara Glow Report
        </h1>
        <button
          onClick={handleReset}
          className="flex items-center text-sm font-semibold p-2 rounded-full bg-violet-200 text-violet-700 hover:bg-violet-300 transition-colors duration-200"
        >
          <ArrowLeft className="w-4 h-4 mr-1" />
          New Analysis
        </button>
      </div>

      {currentData && (
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          {/* Section 1: Personal Skin Tone Analysis */}
          <div className="lg:col-span-1 bg-white p-6 rounded-3xl shadow-xl border-t-8 border-pink-400">
            <SectionTitle icon={Lightbulb} title="Personal Analysis" color="pink" />
            <div className="space-y-4">
              <h3 className="text-xl font-bold text-gray-900">Undertone: {currentData.undertone}</h3>
              <div className="h-4 w-full rounded-full overflow-hidden mb-4 shadow-inner">
                {/* Tone Gradient Mock */}
                <div
                  className="h-full bg-gradient-to-r from-blue-300 via-pink-300 to-yellow-300"
                  style={{ filter: analysisResult === 'warm' ? 'hue-rotate(30deg) saturate(1.5)' : analysisResult === 'cool' ? 'hue-rotate(-30deg) saturate(1.5)' : 'none' }}
                ></div>
              </div>
              <p className="text-gray-600 italic">"{currentData.description}"</p>
            </div>

            <div className="mt-8">
              <h3 className="text-lg font-semibold mb-3 text-gray-900 flex items-center">
                <Palette className="w-5 h-5 mr-2 text-pink-500" />
                Best Color Palette
              </h3>
              <div className="flex justify-around space-x-2">
                {currentData.colorPalette.map((c, i) => (
                  <ColorSwatch key={i} name={c.name} hex={c.hex} />
                ))}
              </div>
            </div>
          </div>

          {/* Section 2: Fashion & Style Recommendations */}
          <div className="lg:col-span-2 bg-white p-6 rounded-3xl shadow-xl border-t-8 border-violet-400">
            <SectionTitle icon={Shirt} title="Fashion & Outfit Match" color="violet" />

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <h3 className="text-xl font-bold mb-2 text-gray-900">{currentData.fashion.title}</h3>
                <p className="text-gray-600 mb-4">{currentData.fashion.styles}</p>

                <div className="p-4 bg-violet-50 rounded-xl border border-violet-200">
                  <p className="font-semibold text-violet-800">Your Signature Look:</p>
                  <p className="text-sm text-gray-700 mt-1">{currentData.fashion.outfit}</p>
                </div>

                <div className="mt-4">
                  <h4 className="font-bold text-lg mb-2 text-gray-900">Mock Product Ideas</h4>
                  <div className="space-y-3">
                    {currentData.fashion.productCard.map((p, i) => (
                      <a key={i} href={p.link} target="_blank" rel="noopener noreferrer" className="flex justify-between items-center p-3 bg-white border border-gray-200 rounded-xl hover:shadow-md transition-shadow">
                        <div>
                          <p className="font-medium text-gray-900">{p.name}</p>
                          <p className="text-xs text-gray-500">{p.marketplace}</p>
                        </div>
                        <span className="font-semibold text-pink-600">{p.price}</span>
                      </a>
                    ))}
                  </div>
                </div>

                <button
                    onClick={() => setIsTryOnActive(!isTryOnActive)}
                    className="mt-6 w-full p-3 font-bold rounded-full text-white transition-all duration-300"
                    style={{ backgroundColor: '#8B5CF6' }} // Violet-500
                >
                    {isTryOnActive ? 'Hide Try-On Preview' : 'Activate "Try-On" Simulation'}
                </button>
              </div>

              {/* Try-On Preview Section */}
              <div className={`rounded-xl overflow-hidden bg-gray-100 p-4 border border-violet-300 ${isTryOnActive ? 'block' : 'hidden md:block'}`}>
                <h4 className="font-bold text-center mb-2 text-gray-900">Try-On Simulation</h4>
                <div className="relative w-full aspect-square bg-white border-2 border-dashed border-violet-300 flex items-center justify-center rounded-lg">
                  <Shirt className="w-10 h-10 text-violet-400 absolute opacity-30" />
                  <div className="text-center">
                    <p className="text-sm text-gray-500">Static Overlay Preview</p>
                    <p className="text-xs text-violet-600 mt-1">
                      {isTryOnActive ? 'Layering outfit mock-up on your photo...' : 'Click "Activate" to see the simulation.'}
                    </p>
                    {photoUrl && isTryOnActive && (
                        <div className="mt-2 w-full h-auto overflow-hidden rounded-md border border-violet-500">
                            <img src={photoUrl} alt="User for Try-On" className="w-full h-full object-cover opacity-30" />
                            <div className="absolute inset-0 flex items-center justify-center bg-violet-400/50">
                                <span className="text-white font-bold text-lg">Mock Outfit Overlay</span>
                            </div>
                        </div>
                    )}
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* Section 3 & 4: Skincare and Diet/Lifestyle */}
          <div className="lg:col-span-3 grid grid-cols-1 md:grid-cols-2 gap-8 mt-4">
            {/* Skincare Tips */}
            <div className="bg-white p-6 rounded-3xl shadow-xl border-t-8 border-pink-400/70">
              <SectionTitle icon={Sun} title="Skincare & Maintenance Tips" color="pink" />
              <div className="space-y-5">
                <div>
                  <h3 className="text-lg font-bold text-gray-900 flex items-center mb-2"><Heart className="w-5 h-5 mr-2 text-pink-600"/> Daily Tips</h3>
                  <p className="text-gray-600">{currentData.skincare.dailyTips}</p>
                </div>
                <div>
                  <h3 className="text-lg font-bold text-gray-900 flex items-center mb-2"><Zap className="w-5 h-5 mr-2 text-pink-600"/> Natural Brightening</h3>
                  <p className="text-gray-600">{currentData.skincare.brightening}</p>
                </div>
                <div>
                  <h3 className="text-lg font-bold text-gray-900 mb-2">Routine Suggestions</h3>
                  <ul className="space-y-2 text-gray-700 text-sm p-4 bg-pink-50 rounded-lg">
                    {Object.entries(currentData.skincare.routine).map(([time, step]) => (
                      <li key={time} className="flex"><Moon className="w-4 h-4 mr-2 text-pink-500" /> <span className="font-semibold capitalize w-20">{time}:</span> {step}</li>
                    ))}
                  </ul>
                </div>
              </div>
            </div>

            {/* Diet & Lifestyle */}
            <div className="bg-white p-6 rounded-3xl shadow-xl border-t-8 border-violet-400/70">
              <SectionTitle icon={Soup} title="Diet & Lifestyle" color="violet" />
              <div className="space-y-5">
                <div>
                  <h3 className="text-lg font-bold text-gray-900 flex items-center mb-2"><ArrowLeft className="w-5 h-5 mr-2 text-violet-600"/> Foods to Avoid</h3>
                  <ul className="list-disc list-inside text-gray-600 space-y-1 ml-4">
                    {currentData.diet.avoid.map((item, i) => <li key={i}>{item}</li>)}
                  </ul>
                </div>
                <div>
                  <h3 className="text-lg font-bold text-gray-900 flex items-center mb-2"><Heart className="w-5 h-5 mr-2 text-violet-600"/> Beneficial Foods</h3>
                  <ul className="list-disc list-inside text-gray-600 space-y-1 ml-4">
                    {currentData.diet.beneficial.map((item, i) => <li key={i}>{item}</li>)}
                  </ul>
                </div>
                <div>
                  <h3 className="text-lg font-bold text-gray-900 flex items-center mb-2"><Sun className="w-5 h-5 mr-2 text-violet-600"/> Hydration & Sleep Tips</h3>
                  <p className="text-gray-600 text-sm p-4 bg-violet-50 rounded-lg">{currentData.diet.hydrationSleep}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );

  const HeroSection = () => (
    <div className="min-h-[70vh] flex items-center justify-center pt-24 pb-12 sm:pb-24">
      <div className="text-center max-w-4xl px-4">
        <h1 className="text-4xl sm:text-6xl font-extrabold text-gray-900 leading-tight mb-4">
          Discover Your <span className="text-pink-500">True Glow</span> with AI
        </h1>
        <p className="text-lg sm:text-xl text-gray-600 mb-10">
          Luminara's advanced AI analyzes your skin tone and undertone from a single photo to unlock personalized fashion, beauty, and wellness secrets.
        </p>

        {/* Action Buttons */}
        <div className="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-6 mb-16">
          <button
            onClick={() => fileInputRef.current.click()}
            disabled={isLoading}
            className={`w-full sm:w-64 p-4 rounded-full font-bold text-white shadow-lg transition-all duration-300 transform hover:scale-[1.03] flex items-center justify-center ${isLoading ? 'bg-gray-400 cursor-not-allowed' : 'bg-pink-500 hover:bg-pink-600'}`}
          >
            <Upload className="w-5 h-5 mr-2" />
            Upload Photo
          </button>

          <input
            type="file"
            accept="image/*"
            ref={fileInputRef}
            onChange={handleFileChange}
            className="hidden"
          />

          <button
            onClick={mockAnalyze} // Mocking direct camera access simplicity
            disabled={isLoading}
            className={`w-full sm:w-64 p-4 rounded-full font-bold text-gray-900 border-2 transition-all duration-300 transform hover:scale-[1.03] flex items-center justify-center ${isLoading ? 'border-gray-400 bg-white cursor-not-allowed' : 'border-violet-500 hover:bg-violet-50'}`}
          >
            <Camera className="w-5 h-5 mr-2" />
            Use Live Camera (Mock)
          </button>
        </div>

        {/* Loading Indicator */}
        {isLoading && (
          <div className="flex items-center justify-center text-lg font-semibold text-violet-600">
            <Loader2 className="w-6 h-6 mr-3 animate-spin" />
            Analyzing {photoUrl ? 'your image' : 'your tone'}... Please wait a moment for AI insights.
          </div>
        )}

      </div>
    </div>
  );

  const HowItWorksSection = () => (
    <div className="py-16 bg-pink-50/50">
      <div className="container mx-auto px-4 sm:px-8">
        <h2 className="text-3xl font-extrabold text-center text-gray-900 mb-12">How It Works</h2>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
          <div className="flex flex-col items-center text-center p-6 bg-white rounded-2xl shadow-lg hover:shadow-xl transition-shadow duration-300">
            <div className="w-12 h-12 flex items-center justify-center rounded-full bg-pink-200 mb-4 font-bold text-pink-700 text-xl">1</div>
            <h3 className="text-xl font-bold text-gray-900 mb-2">Capture</h3>
            <p className="text-gray-600">Take a photo with natural light or upload an existing image of your face and neck.</p>
          </div>
          <div className="flex flex-col items-center text-center p-6 bg-white rounded-2xl shadow-lg hover:shadow-xl transition-shadow duration-300">
            <div className="w-12 h-12 flex items-center justify-center rounded-full bg-violet-200 mb-4 font-bold text-violet-700 text-xl">2</div>
            <h3 className="text-xl font-bold text-gray-900 mb-2">Analyze</h3>
            <p className="text-gray-600">Our proprietary AI algorithm detects your precise skin tone and undertone in seconds.</p>
          </div>
          <div className="flex flex-col items-center text-center p-6 bg-white rounded-2xl shadow-lg hover:shadow-xl transition-shadow duration-300">
            <div className="w-12 h-12 flex items-center justify-center rounded-full bg-pink-200 mb-4 font-bold text-pink-700 text-xl">3</div>
            <h3 className="text-xl font-bold text-gray-900 mb-2">Glow</h3>
            <p className="text-gray-600">Receive your complete, personalized report on fashion, beauty, and diet tips.</p>
          </div>
        </div>
      </div>
    </div>
  );

  const Footer = () => (
    <footer className="bg-gray-900 text-white py-12">
      <div className="container mx-auto px-4 sm:px-8 flex flex-col md:flex-row justify-between items-center">
        <div className="text-2xl font-black text-pink-300 mb-6 md:mb-0">
          Luminara
        </div>
        <div className="flex space-x-6 text-sm text-gray-400">
          <a href="#" className="hover:text-pink-300 transition-colors">About Us</a>
          <a href="#" className="hover:text-pink-300 transition-colors">Contact</a>
          <a href="#" className="hover:text-pink-300 transition-colors">Privacy Policy</a>
          <a href="#" className="hover:text-pink-300 transition-colors">Blog (Mock)</a>
        </div>
        <p className="mt-8 md:mt-0 text-xs text-gray-500">
          &copy; {new Date().getFullYear()} Luminara. Discover your light.
        </p>
      </div>
    </footer>
  );

  // --- Main Render ---
  return (
    <div className="min-h-screen bg-gray-50 font-sans" style={{ fontFamily: 'Inter, sans-serif' }}>
      {/* Tailwind Script: Corrected syntax using template literal */}
      <script src="https://cdn.tailwindcss.com"></script>
      <script dangerouslySetInnerHTML={{ __html: `
        tailwind.config = {
          theme: {
            extend: {
              colors: {
                'pastel-pink': '#FBCFE8',
                'lilac-purple': '#DDD6FE',
              },
              fontFamily: {
                sans: ['Inter', 'sans-serif'],
              },
            },
          },
        };
      ` }} />

      {/* Navbar (Minimalist) */}
      <header className="fixed top-0 left-0 w-full bg-white bg-opacity-90 backdrop-blur-sm z-10 shadow-sm">
        <nav className="container mx-auto px-4 sm:px-8 flex justify-between items-center py-4">
          <div className="text-2xl font-black text-gray-900">
            <span className="text-pink-500">Lumi</span>nara
          </div>
          <button
            onClick={() => console.log("Mock Navigation: Navigate to blog.")}
            className="text-sm font-semibold p-2 rounded-full text-gray-700 hover:text-pink-500 transition-colors hidden sm:block"
          >
            AI Glow Tips
          </button>
        </nav>
      </header>

      <main className="pt-16">
        {!isAnalyzing ? (
          <>
            <HeroSection />
            <HowItWorksSection />
          </>
        ) : (
          <ResultsDashboard />
        )}

      </main>

      <Footer />
    </div>
  );
};

export default App;
