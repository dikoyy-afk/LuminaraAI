<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LUMINARA | Personal Color Analysis</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Fonts and Colors */
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        :root {
            --color-lilac: #D8B4FE; /* Soft Lilac */
            --color-ivory: #FBFBF2; /* Ivory */
            --color-gold: #D4AF37; /* Champagne Gold */
            --color-dark: #1F2937; /* Dark Mode Base */
        }

        .font-serif-main { font-family: 'Playfair Display', serif; }
        .font-sans-main { font-family: 'Inter', sans-serif; }
        
        /* Apply base styling */
        body {
            background-color: var(--color-ivory);
            color: var(--color-dark);
            transition: background-color 0.5s, color 0.5s;
        }
        .dark body {
            background-color: var(--color-dark);
            color: var(--color-ivory);
        }

        .cta-button {
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .cta-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 10px rgba(0, 0, 0, 0.15);
        }
        .dark .cta-button {
            background-color: var(--color-lilac);
            color: var(--color-dark);
        }
        
        .dark .card {
            background-color: #374151; /* Darker Card */
        }

        /* Fullscreen Video/Canvas for Analysis */
        #video-preview, #canvas-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 1rem;
            max-height: 400px;
        }

        .color-swatch {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .color-swatch:hover {
            transform: scale(1.1);
        }

        /* Custom scrollbar for aesthetic */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--color-lilac);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #F0F0F0;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: var(--color-gold);
        }
        .dark ::-webkit-scrollbar-track {
            background: #252525;
        }
    </style>
</head>
<body class="font-sans-main min-h-screen">
    <div id="app-container" class="max-w-7xl mx-auto p-4 sm:p-8">
        
        <!-- Navbar -->
        <nav class="flex justify-between items-center py-4 border-b border-gray-200 dark:border-gray-700">
            <h1 class="text-3xl font-serif-main font-extrabold text-purple-600 dark:text-yellow-300">LUMINARA</h1>
            <div class="flex space-x-4 items-center">
                <button onclick="goToPage('landing')" class="text-gray-600 dark:text-gray-300 hover:text-purple-600 dark:hover:text-yellow-300 transition">Home</button>
                <button onclick="goToPage('about')" class="text-gray-600 dark:text-gray-300 hover:text-purple-600 dark:hover:text-yellow-300 transition">About</button>
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition">
                    <!-- Sun/Moon SVG -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-moon dark:lucide-sun"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
                </button>
            </div>
        </nav>

        <!-- Pages Container -->
        <main id="pages" class="mt-8">
            <!-- Landing Page -->
            <div id="landing" data-page="landing" class="page-content space-y-12">
                <header class="text-center py-20 bg-gradient-to-br from-purple-100/50 to-pink-50/50 dark:from-gray-800 dark:to-gray-900 rounded-2xl shadow-xl">
                    <h2 class="text-5xl md:text-7xl font-serif-main font-bold leading-tight text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-500 dark:from-yellow-300 dark:to-pink-300">
                        Discover Your <br> Authentic Hue
                    </h2>
                    <p class="mt-4 text-lg md:text-xl text-gray-700 dark:text-gray-300 max-w-2xl mx-auto font-sans-main">
                        LUMINARA helps you shine through your most authentic colors. Unveil your personal undertone and seasonal profile.
                    </p>
                    <button onclick="goToPage('analysis')" class="cta-button mt-8 px-10 py-4 text-lg font-bold rounded-full bg-purple-500 text-white hover:bg-purple-600 transition duration-300 transform shadow-lg shadow-purple-200/50">
                        Analyze My Color
                    </button>
                </header>

                <section class="grid md:grid-cols-3 gap-8">
                    <div class="card p-6 rounded-xl bg-white dark:bg-gray-800 shadow-lg space-y-3">
                        <h3 class="text-2xl font-serif-main font-semibold text-purple-600 dark:text-yellow-300">Undertone</h3>
                        <p class="text-gray-600 dark:text-gray-400">The underlying hue of your skin (Cool, Warm, or Neutral) that never changes, guiding your best metals and makeup.</p>
                    </div>
                    <div class="card p-6 rounded-xl bg-white dark:bg-gray-800 shadow-lg space-y-3">
                        <h3 class="text-2xl font-serif-main font-semibold text-purple-600 dark:text-yellow-300">Seasonal Profile</h3>
                        <p class="text-gray-600 dark:text-gray-400">Determine your specific color season (Spring, Summer, Autumn, Winter) based on brightness, depth, and temperature.</p>
                    </div>
                    <div class="card p-6 rounded-xl bg-white dark:bg-gray-800 shadow-lg space-y-3">
                        <h3 class="text-2xl font-serif-main font-semibold text-purple-600 dark:text-yellow-300">Outfit Matching</h3>
                        <p class="text-gray-600 dark:text-gray-400">Get curated recommendations, including traditional Indonesian outfits, tailored to your unique color profile.</p>
                    </div>
                </section>
            </div>

            <!-- Analysis Page -->
            <div id="analysis" data-page="analysis" class="page-content hidden space-y-8">
                <h2 class="text-4xl font-serif-main font-bold text-center text-gray-800 dark:text-gray-100 mb-8">Start Your Analysis</h2>
                
                <div class="grid lg:grid-cols-2 gap-8">
                    <div class="col-span-1 space-y-4">
                        <div class="bg-gray-200 dark:bg-gray-700 rounded-xl p-2 h-96 flex items-center justify-center relative overflow-hidden">
                            <video id="video-preview" autoplay playsinline class="hidden absolute top-0 left-0 w-full h-full object-cover"></video>
                            <canvas id="canvas-preview" class="hidden absolute top-0 left-0 w-full h-full object-cover"></canvas>
                            <img id="image-preview" src="https://placehold.co/400x400/D8B4FE/FBFBF2?text=Camera+or+Image+Preview" alt="Placeholder" class="w-full h-full object-cover rounded-xl" />
                        </div>
                        <p id="analysis-status" class="text-center text-sm text-gray-500 dark:text-gray-400">Select an option below to begin.</p>
                    </div>

                    <div class="col-span-1 space-y-6">
                        <div class="card p-6 rounded-xl bg-white dark:bg-gray-800 shadow-lg space-y-4">
                            <h3 class="text-2xl font-serif-main font-semibold text-purple-600 dark:text-yellow-300 mb-4">Method & Preferences</h3>

                            <!-- Method Selection -->
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Analysis Method</label>
                                <div class="flex space-x-4">
                                    <button id="btn-camera" onclick="startCamera()" class="flex-1 px-4 py-2 rounded-lg bg-purple-500 text-white hover:bg-purple-600 transition disabled:opacity-50" disabled>
                                        Use Real-Time Camera (Simulated)
                                    </button>
                                    <button id="btn-upload" onclick="document.getElementById('file-input').click()" class="flex-1 px-4 py-2 rounded-lg bg-purple-500 text-white hover:bg-purple-600 transition">
                                        Upload Photo
                                    </button>
                                    <input type="file" id="file-input" accept="image/*" class="hidden" onchange="handleFileUpload(event)">
                                </div>
                            </div>
                            
                            <!-- Gender Selection (for Recommendations) -->
                            <div class="space-y-2 pt-4">
                                <label for="gender-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Select Gender (For Outfit Recs)</label>
                                <select id="gender-select" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-gray-100">
                                    <option value="female">Female</option>
                                    <option value="male">Male</option>
                                </select>
                            </div>

                            <button id="btn-start-analysis" onclick="runAnalysisSimulation()" class="cta-button w-full px-6 py-3 text-xl font-bold rounded-xl bg-purple-500 text-white hover:bg-purple-600 transition mt-6 disabled:opacity-50" disabled>
                                Start Analysis
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Page -->
            <div id="results" data-page="results" class="page-content hidden space-y-12">
                <h2 class="text-4xl font-serif-main font-bold text-center text-gray-800 dark:text-gray-100 mb-8">Your LUMINARA Profile</h2>

                <div id="loading-spinner" class="text-center py-20 hidden">
                    <svg class="animate-spin mx-auto h-12 w-12 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-4 text-xl font-serif-main text-gray-600 dark:text-gray-300">Generating personalized recommendations...</p>
                </div>

                <div id="results-content" class="space-y-12 hidden">
                    <!-- Section 1: Core Profile -->
                    <div class="grid md:grid-cols-3 gap-8 p-6 bg-purple-50 dark:bg-gray-700 rounded-2xl shadow-xl">
                        <div class="md:col-span-1 space-y-2">
                            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Your Undertone</p>
                            <h3 id="result-undertone" class="text-3xl font-serif-main font-extrabold text-purple-700 dark:text-yellow-300"></h3>
                            <p id="result-metal" class="text-lg text-gray-600 dark:text-gray-200 font-medium"></p>
                        </div>
                        <div class="md:col-span-2 space-y-2">
                            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Your Seasonal Profile</p>
                            <h3 id="result-season" class="text-3xl font-serif-main font-extrabold text-purple-700 dark:text-yellow-300"></h3>
                            <p id="result-season-desc" class="text-gray-600 dark:text-gray-300"></p>
                        </div>
                    </div>

                    <!-- Section 2: Detailed Explanation -->
                    <div class="grid lg:grid-cols-2 gap-8">
                        <div class="card p-6 rounded-xl bg-white dark:bg-gray-800 shadow-lg space-y-4">
                            <h4 class="text-2xl font-serif-main font-semibold border-b pb-2 text-purple-600 dark:text-yellow-300">Undertone Characteristics</h4>
                            <p id="result-undertone-desc" class="text-gray-700 dark:text-gray-300"></p>
                            <ul id="result-undertone-list" class="list-disc pl-5 space-y-2 text-sm text-gray-600 dark:text-gray-400">
                                <!-- Characteristics go here -->
                            </ul>
                        </div>
                        <div class="card p-6 rounded-xl bg-white dark:bg-gray-800 shadow-lg space-y-4">
                            <h4 class="text-2xl font-serif-main font-semibold border-b pb-2 text-purple-600 dark:text-yellow-300">Seasonal Attributes</h4>
                            <p id="result-season-attributes" class="text-gray-700 dark:text-gray-300"></p>
                            <ul class="list-disc pl-5 space-y-2 text-sm text-gray-600 dark:text-gray-400">
                                <li>**Temperature:** <span id="season-attr-temp"></span></li>
                                <li>**Depth:** <span id="season-attr-depth"></span></li>
                                <li>**Brightness:** <span id="season-attr-bright"></span></li>
                            </ul>
                        </div>
                    </div>

                    <!-- Section 3: Color Palettes -->
                    <div class="card p-8 rounded-2xl bg-white dark:bg-gray-800 shadow-xl space-y-6">
                        <h4 class="text-3xl font-serif-main font-extrabold text-center text-purple-700 dark:text-yellow-300">Your LUMINARA Color Palette</h4>
                        
                        <div class="space-y-6">
                            <p class="text-xl font-semibold text-gray-800 dark:text-gray-100">Primary Palette</p>
                            <div id="palette-primary" class="flex flex-wrap gap-4 justify-center"></div>
                        </div>

                        <div class="space-y-6">
                            <p class="text-xl font-semibold text-gray-800 dark:text-gray-100">Accent Colors</p>
                            <div id="palette-accent" class="flex flex-wrap gap-4 justify-center"></div>
                        </div>

                        <div class="space-y-6">
                            <p class="text-xl font-semibold text-red-600 dark:text-red-400">Avoid Colors</p>
                            <div id="palette-avoid" class="flex flex-wrap gap-4 justify-center"></div>
                        </div>
                    </div>

                    <!-- Section 4: Outfit Recommendations -->
                    <div class="space-y-10">
                        <h4 class="text-4xl font-serif-main font-extrabold text-center text-gray-800 dark:text-gray-100">Personalized Outfit Recommendations</h4>

                        <!-- Casual Outfits -->
                        <div class="card p-6 rounded-xl bg-white dark:bg-gray-800 shadow-lg space-y-4">
                            <h5 class="text-2xl font-serif-main font-semibold border-b pb-2 text-purple-600 dark:text-yellow-300">Casual Style Guide (<span id="reco-gender"></span>)</h5>
                            <div id="reco-casual" class="grid md:grid-cols-3 gap-6">
                                <!-- Casual outfit cards generated by API -->
                            </div>
                        </div>

                        <!-- Traditional Indonesian Outfits -->
                        <div class="card p-6 rounded-xl bg-white dark:bg-gray-800 shadow-lg space-y-4">
                            <h5 class="text-2xl font-serif-main font-semibold border-b pb-2 text-purple-600 dark:text-yellow-300">Traditional Indonesian Styles</h5>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Curated examples of Batik, Kebaya, and other regional outfits matching your profile.</p>
                            <div id="reco-traditional" class="grid md:grid-cols-3 gap-6">
                                <!-- Traditional outfit cards generated by API -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- About LUMINARA Page -->
            <div id="about" data-page="about" class="page-content hidden space-y-8 max-w-4xl mx-auto py-16">
                <h2 class="text-5xl font-serif-main font-bold text-center text-gray-800 dark:text-gray-100">About LUMINARA</h2>
                
                <div class="card p-10 rounded-2xl bg-white dark:bg-gray-800 shadow-2xl space-y-6">
                    <p class="text-lg text-gray-700 dark:text-gray-300 font-serif-main italic text-center">
                        “Helping you shine through your most authentic colors.”
                    </p>
                    
                    <div class="space-y-4 text-gray-600 dark:text-gray-400">
                        <p>LUMINARA, derived from the word 'Luminous' (emitting light), is your personal guide to discovering the colors that make you glow. We believe that understanding your unique skin undertone and seasonal color profile is the key to unlocking true personal style and confidence.</p>
                        <p>Our platform simulates a sophisticated analysis process, cross-referencing millions of color data points to provide you with a comprehensive profile. From identifying whether you sparkle in gold or silver to defining your perfect seasonal palette (Spring, Summer, Autumn, or Winter), LUMINARA provides actionable, personalized recommendations.</p>
                        <p>We are dedicated to fusing global style with local richness, offering specialized recommendations for **Traditional Indonesian Outfits** like Batik, Kebaya, and Ulos, ensuring your heritage shines alongside your modern style. All analyses are done locally on your device for maximum **privacy and security**.</p>
                    </div>
                    
                    <div class="flex justify-center pt-4">
                        <button onclick="goToPage('landing')" class="cta-button px-6 py-3 text-lg font-medium rounded-full bg-purple-500 text-white hover:bg-purple-600 transition duration-300">
                            Start Your Journey
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Message Box -->
    <div id="message-box" class="fixed bottom-4 right-4 p-4 rounded-lg shadow-xl bg-red-100 text-red-700 hidden z-50 transition-opacity duration-300"></div>

    <script>
        // --- GLOBAL STATE AND CONFIGURATION ---
        let currentPage = 'landing';
        let analysisResult = {
            undertone: null,
            season: null,
            gender: 'female',
        };
        let recommendations = {
            casualOutfits: [],
            traditionalOutfits: []
        };
        let videoStream = null;

        const apiKey = ""; // API Key for Gemini API (left empty for Canvas environment)
        const apiUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";

        // --- PAGE CONTENT MAPPING ---
        const ALL_SEASONS = {
            'Spring': {
                undertone: 'Warm',
                description: 'Clear, light, and warm. Your colors are sunny, fresh, and bright, mirroring the colors of the first flowers and green leaves.',
                attributes: { temp: 'Warm', depth: 'Light', bright: 'Bright' },
                primary: ['#F5D10A', '#92D735', '#F8B180', '#56C5B5'],
                accent: ['#E06377', '#A1C7D6'],
                avoid: ['#000000', '#4B4B4B', '#5A1F52']
            },
            'Summer': {
                undertone: 'Cool',
                description: 'Soft, muted, and cool. Your colors are dusty, smoky, and gentle, reminiscent of a hazy summer day.',
                attributes: { temp: 'Cool', depth: 'Light to Medium', bright: 'Soft/Muted' },
                primary: ['#A0D8D6', '#B4C4E3', '#6A92A8', '#E6C6D3'],
                accent: ['#9A99AA', '#F0A1B0'],
                avoid: ['#FFC300', '#F29F00', '#0047AB']
            },
            'Autumn': {
                undertone: 'Warm',
                description: 'Deep, rich, and warm. Your colors are earthy, spicy, and saturated, like the foliage of late fall.',
                attributes: { temp: 'Warm', depth: 'Deep', bright: 'Muted/Soft' },
                primary: ['#B85C38', '#E69E00', '#5D4037', '#738678'],
                accent: ['#922B21', '#FFD700'],
                avoid: ['#00BFFF', '#5DADE2', '#0000FF']
            },
            'Winter': {
                undertone: 'Cool',
                description: 'Clear, deep, and cool. Your colors are icy, vivid, and highly contrasted, like a snowy winter landscape.',
                attributes: { temp: 'Cool', depth: 'Deep', bright: 'Clear/Vivid' },
                primary: ['#FFFFFF', '#000000', '#FF0000', '#000080'],
                accent: ['#B40093', '#00FFFF'],
                avoid: ['#FAEBD7', '#F5DEB3', '#D2B48C']
            }
        };

        const ALL_UNDERTONES = {
            'Cool': {
                description: 'Your skin has a hint of blue, red, or pink. You tan slowly, and your veins appear blue or purple.',
                characteristics: [
                    'Veins appear blue or purple on the inner wrist.',
                    'Skin tends to burn easily or tan slowly.',
                    'Best suited for Silver, Platinum, and White Gold jewelry.'
                ],
                metal: 'Silver'
            },
            'Warm': {
                description: 'Your skin has a golden, yellow, or peach tint. You tan easily, and your veins appear green or olive.',
                characteristics: [
                    'Veins appear greenish or olive on the inner wrist.',
                    'Skin tans easily to a golden-brown hue.',
                    'Best suited for Gold, Copper, and Bronze jewelry.'
                ],
                metal: 'Gold'
            },
            'Neutral': {
                description: 'Your skin has a mix of both cool and warm tones, or your undertone matches your surface skin color. Your veins appear a mix of blue and green.',
                characteristics: [
                    'Veins are difficult to distinguish as green or blue.',
                    'You can wear both silver and gold jewelry beautifully.',
                    'Best suited for a mix of colors from both cool and warm palettes.'
                ],
                metal: 'Gold & Silver'
            }
        };

        // --- UTILITY FUNCTIONS ---

        /**
         * Simple custom message box.
         * @param {string} message 
         * @param {string} type - 'success', 'error', 'warning'
         */
        function showMessage(message, type = 'error') {
            const box = document.getElementById('message-box');
            let bgColor, textColor;

            switch (type) {
                case 'success':
                    bgColor = 'bg-green-100';
                    textColor = 'text-green-700';
                    break;
                case 'warning':
                    bgColor = 'bg-yellow-100';
                    textColor = 'text-yellow-700';
                    break;
                case 'error':
                default:
                    bgColor = 'bg-red-100';
                    textColor = 'text-red-700';
                    break;
            }

            box.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-xl ${bgColor} ${textColor} z-50 transition-opacity duration-300`;
            box.textContent = message;
            box.style.display = 'block';

            setTimeout(() => {
                box.style.opacity = '0';
                setTimeout(() => {
                    box.style.display = 'hidden';
                    box.style.opacity = '1';
                }, 300);
            }, 5000);
        }

        // --- API INTEGRATION (Gemini for Content Generation) ---

        /**
         * Calls the Gemini API with structured response schema and retry logic.
         * @param {string} systemInstruction - The system prompt for the model.
         * @param {string} userPrompt - The user query.
         * @param {object} responseSchema - The JSON schema for structured output.
         * @returns {Promise<object|null>} Parsed JSON response from the model.
         */
        async function callGeminiApi(systemInstruction, userPrompt, responseSchema) {
            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema
                }
            };

            const maxRetries = 3;
            let delay = 1000;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(`${apiUrl}?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && i < maxRetries - 1) {
                            // Too many requests, retry with exponential backoff
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 2;
                            continue;
                        }
                        throw new Error(`API call failed with status: ${response.status}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate?.content?.parts?.[0]?.text) {
                        const jsonText = candidate.content.parts[0].text;
                        // Gemini may wrap JSON in markdown block, clean it up
                        const cleanedJsonText = jsonText.replace(/^```json\n|```$/g, '').trim();
                        try {
                            return JSON.parse(cleanedJsonText);
                        } catch (e) {
                            console.error("Failed to parse JSON response:", cleanedJsonText, e);
                            throw new Error("Invalid JSON structure returned by model.");
                        }
                    } else {
                        throw new Error("No content found in API response.");
                    }

                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error);
                    if (i === maxRetries - 1) {
                        showMessage("Failed to generate outfit recommendations after multiple retries.", 'error');
                        return null;
                    }
                }
            }
        }

        /**
         * Generates and fetches outfit recommendations using the Gemini API.
         */
        async function fetchRecommendations() {
            document.getElementById('loading-spinner').classList.remove('hidden');
            document.getElementById('results-content').classList.add('hidden');

            const { undertone, season, gender } = analysisResult;
            const userPrompt = `Generate 3 casual outfit sets and 3 traditional Indonesian outfit options for a person with a ${undertone} undertone and a ${season} seasonal profile, identified as ${gender}. Use simple placeholder image URLs like 'https://placehold.co/400x400/D4AF37/FBFBF2?text=Inspiration' for all images.`;
            
            const systemInstruction = `You are a world-class fashion and cultural expert specializing in personal color analysis. Provide detailed, stylish, and culturally appropriate outfit recommendations in the requested JSON format. Ensure all inspirationImage fields contain a generic placeholder image URL. The casual outfits must include a top, bottom, and accessories. The traditional outfits must include the outfit name, cultural background summary, and matching color suggestions.`;

            const responseSchema = {
                type: "OBJECT",
                properties: {
                    casualOutfits: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                top: { "type": "STRING", description: "e.g., Cashmere Sweater" },
                                bottom: { "type": "STRING", description: "e.g., Navy Wool Trousers" },
                                accessories: { "type": "STRING", description: "e.g., Silver watch and pearl earrings" },
                                description: { "type": "STRING", description: "A brief description of the full set." },
                                inspirationImage: { "type": "STRING" }
                            },
                            required: ["top", "bottom", "accessories", "description", "inspirationImage"]
                        }
                    },
                    traditionalOutfits: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                outfitName: { "type": "STRING", description: "e.g., Kebaya Jawa with Kain Batik" },
                                culturalBackground: { "type": "STRING", description: "A concise summary of the garment's origin/meaning." },
                                matchingColors: { "type": "STRING", description: "Specific colors from the season's palette (e.g., Soft Pink and Dusty Blue)." },
                                description: { "type": "STRING", description: "A brief description of the traditional attire's components." },
                                inspirationImage: { "type": "STRING" }
                            },
                            required: ["outfitName", "culturalBackground", "matchingColors", "description", "inspirationImage"]
                        }
                    }
                },
                required: ["casualOutfits", "traditionalOutfits"]
            };

            const data = await callGeminiApi(systemInstruction, userPrompt, responseSchema);

            document.getElementById('loading-spinner').classList.add('hidden');
            document.getElementById('results-content').classList.remove('hidden');

            if (data) {
                recommendations = data;
                renderResults();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }


        // --- UI LOGIC AND NAVIGATION ---

        /**
         * Switches the current page view.
         * @param {string} pageId - The ID of the page to show.
         */
        function goToPage(pageId) {
            currentPage = pageId;
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.add('hidden');
            });
            document.getElementById(pageId).classList.remove('hidden');

            // Cleanup for analysis page
            if (pageId !== 'analysis') {
                stopCamera();
            }
            if (pageId === 'results') {
                // Do nothing, results are rendered after API call
            }
            if (pageId === 'landing') {
                analysisResult.undertone = null; // Reset analysis state
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        /**
         * Renders the simulated analysis results and recommendations.
         */
        function renderResults() {
            const { undertone, season, gender } = analysisResult;
            const seasonData = ALL_SEASONS[season];
            const undertoneData = ALL_UNDERTONES[undertone];
            
            // 1. Core Profile
            document.getElementById('result-undertone').textContent = undertone;
            document.getElementById('result-season').textContent = season;
            document.getElementById('result-metal').textContent = `Best Metal: ${undertoneData.metal}`;
            document.getElementById('reco-gender').textContent = gender.charAt(0).toUpperCase() + gender.slice(1);

            // 2. Explanations
            document.getElementById('result-season-desc').textContent = seasonData.description;
            document.getElementById('result-undertone-desc').textContent = undertoneData.description;

            // 2.1 Undertone Characteristics List
            const undertoneList = document.getElementById('result-undertone-list');
            undertoneList.innerHTML = undertoneData.characteristics.map(c => `<li>${c}</li>`).join('');

            // 2.2 Seasonal Attributes
            document.getElementById('season-attr-temp').textContent = seasonData.attributes.temp;
            document.getElementById('season-attr-depth').textContent = seasonData.attributes.depth;
            document.getElementById('season-attr-bright').textContent = seasonData.attributes.bright;

            // 3. Color Palettes
            const renderPalette = (elementId, hexArray) => {
                const container = document.getElementById(elementId);
                container.innerHTML = hexArray.map(hex => `
                    <div class="color-swatch bg-[${hex}]" style="background-color: ${hex};" title="${hex}">
                        <span class="text-xs font-bold ${isDark(hex) ? 'text-white' : 'text-gray-800'} opacity-0 hover:opacity-100 transition-opacity">${hex}</span>
                    </div>
                `).join('');
            };

            renderPalette('palette-primary', seasonData.primary);
            renderPalette('palette-accent', seasonData.accent);
            renderPalette('palette-avoid', seasonData.avoid);

            // 4. Recommendations
            const renderCasual = (containerId, outfits) => {
                const container = document.getElementById(containerId);
                container.innerHTML = outfits.map(outfit => `
                    <div class="space-y-3 p-4 border border-gray-100 dark:border-gray-700 rounded-xl shadow-md">
                        <img src="${outfit.inspirationImage}" alt="Casual Outfit Inspiration" class="w-full h-48 object-cover rounded-lg" onerror="this.onerror=null;this.src='https://placehold.co/400x200/5B21B6/FBFBF2?text=Casual+Inspiration';" />
                        <p class="font-semibold text-gray-800 dark:text-gray-100">${outfit.description}</p>
                        <ul class="text-sm text-gray-600 dark:text-gray-400 space-y-1">
                            <li><span class="font-bold">Top:</span> ${outfit.top}</li>
                            <li><span class="font-bold">Bottom:</span> ${outfit.bottom}</li>
                            <li><span class="font-bold">Accs:</span> ${outfit.accessories}</li>
                        </ul>
                    </div>
                `).join('');
            };

            const renderTraditional = (containerId, outfits) => {
                const container = document.getElementById(containerId);
                container.innerHTML = outfits.map(outfit => `
                    <div class="space-y-3 p-4 border border-gray-100 dark:border-gray-700 rounded-xl shadow-md">
                        <img src="${outfit.inspirationImage}" alt="${outfit.outfitName} Inspiration" class="w-full h-48 object-cover rounded-lg" onerror="this.onerror=null;this.src='https://placehold.co/400x200/D4AF37/1F2937?text=Traditional+Outfit';" />
                        <h6 class="font-bold text-lg text-purple-600 dark:text-yellow-300">${outfit.outfitName}</h6>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Colors: ${outfit.matchingColors}</p>
                        <p class="text-sm italic text-gray-600 dark:text-gray-300">${outfit.culturalBackground}</p>
                    </div>
                `).join('');
            };

            renderCasual('reco-casual', recommendations.casualOutfits);
            renderTraditional('reco-traditional', recommendations.traditionalOutfits);
        }

        /**
         * Determines if a hex color is dark for text contrast.
         * @param {string} hex - Hex color code.
         */
        function isDark(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            if (!result) return false;
            const r = parseInt(result[1], 16);
            const g = parseInt(result[2], 16);
            const b = parseInt(result[3], 16);
            // ITU BT.709 Luminance formula
            const luminance = (0.2126 * r + 0.7152 * g + 0.0722 * b) / 255;
            return luminance < 0.5;
        }

        // --- CAMERA AND FILE HANDLING ---

        function startCamera() {
            const video = document.getElementById('video-preview');
            const status = document.getElementById('analysis-status');
            const startBtn = document.getElementById('btn-start-analysis');
            const imagePreview = document.getElementById('image-preview');

            if (videoStream) {
                stopCamera();
            }

            // Simulate the user taking a photo after camera is enabled
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    videoStream = stream;
                    video.srcObject = stream;
                    video.classList.remove('hidden');
                    imagePreview.classList.add('hidden');
                    status.textContent = 'Camera active. Position face clearly and click "Start Analysis".';
                    startBtn.disabled = false;
                })
                .catch(err => {
                    console.error("Error accessing camera: ", err);
                    showMessage('Camera access denied or failed. Please use the photo upload option.', 'error');
                    startBtn.disabled = true;
                });
        }

        function stopCamera() {
            const video = document.getElementById('video-preview');
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            video.classList.add('hidden');
            document.getElementById('image-preview').classList.remove('hidden');
            document.getElementById('analysis-status').textContent = 'Select an option below to begin.';
            document.getElementById('btn-start-analysis').disabled = true;
        }

        function handleFileUpload(event) {
            stopCamera(); // Stop camera if active
            const file = event.target.files[0];
            const imagePreview = document.getElementById('image-preview');
            const status = document.getElementById('analysis-status');
            const startBtn = document.getElementById('btn-start-analysis');

            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreview.classList.remove('hidden');
                    status.textContent = 'Photo uploaded. Click "Start Analysis".';
                    startBtn.disabled = false;
                };
                reader.readAsDataURL(file);
            }
        }

        // --- ANALYSIS SIMULATION ---

        function runAnalysisSimulation() {
            if (document.getElementById('btn-start-analysis').disabled) {
                showMessage("Please upload a photo or start the camera first.", 'warning');
                return;
            }
            
            // 1. Stop camera and disable button
            stopCamera();
            document.getElementById('btn-start-analysis').disabled = true;

            // 2. Simulate AI Analysis: Randomly pick results
            const undertones = ['Neutral', 'Warm', 'Cool'];
            const seasons = ['Spring', 'Summer', 'Autumn', 'Winter'];

            const selectedUndertone = undertones[Math.floor(Math.random() * undertones.length)];
            let selectedSeason;

            // Ensure Season aligns with the simulated Undertone
            if (selectedUndertone === 'Warm') {
                const warmSeasons = ['Spring', 'Autumn'];
                selectedSeason = warmSeasons[Math.floor(Math.random() * warmSeasons.length)];
            } else if (selectedUndertone === 'Cool') {
                const coolSeasons = ['Summer', 'Winter'];
                selectedSeason = coolSeasons[Math.floor(Math.random() * coolSeasons.length)];
            } else { // Neutral can lean either way
                selectedSeason = seasons[Math.floor(Math.random() * seasons.length)];
            }

            analysisResult.undertone = selectedUndertone;
            analysisResult.season = selectedSeason;
            analysisResult.gender = document.getElementById('gender-select').value;
            
            // 3. Move to results page and trigger API content generation
            goToPage('results');
            fetchRecommendations();
        }

        // --- THEME TOGGLE ---

        function setupThemeToggle() {
            const toggleButton = document.getElementById('theme-toggle');
            const isDarkMode = localStorage.getItem('theme') === 'dark' || 
                                (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
            
            if (isDarkMode) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }

            toggleButton.onclick = () => {
                if (document.documentElement.classList.contains('dark')) {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                } else {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                }
            };
        }

        // --- INITIALIZATION ---
        
        window.onload = function() {
            setupThemeToggle();
            goToPage('landing'); // Start on the landing page

            // Check for camera availability and update button state
            navigator.mediaDevices.enumerateDevices()
                .then(devices => {
                    const videoDevices = devices.filter(device => device.kind === 'videoinput');
                    if (videoDevices.length > 0) {
                        document.getElementById('btn-camera').disabled = false;
                    } else {
                        document.getElementById('btn-camera').textContent = 'Camera Not Available';
                        showMessage('No camera found on this device. Please use photo upload.', 'warning');
                    }
                })
                .catch(err => {
                    console.error("Device enumeration failed:", err);
                    document.getElementById('btn-camera').textContent = 'Camera Check Failed';
                });
        };
    </script>
</body>
</html>
